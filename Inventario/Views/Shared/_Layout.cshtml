@using Microsoft.AspNetCore.Identity

@inject SignInManager<IdentityUser> SignInManager
<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>


    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="../../lib/materialize/css/materialize.min.css" media="screen,projection" />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-alpha.4/css/materialize.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://mrrio.github.io/jsPDF/dist/jspdf.debug.js"></script>
    <script src="~/lib/jquery/src/jspdf.min.js"></script>
    <script src="~/lib/jquery/src/jspdf.plugin.autotable.min.js"></script>
    <script type="text/javascript">
        'use strict';
        //mostrar();
        var productos;
        var factura;
        var factUltima;
        var detalles = [[]];
        var datos_g = [[]];
        var total = 0;
        var sumatoria = [[]];
        var xhr = new XMLHttpRequest();
        var xhr2 = new XMLHttpRequest();

        function cargarProductos() {
            xhr.open('GET', 'http://localhost:5913/Producto/ObtenerProducto', 'true');
            xhr.responseType = 'text';
            xhr.send();
        }

        xhr.onload = function () {
            if (xhr.status === 200) {
                productos = JSON.parse(xhr.responseText);
                console.log(productos);
            }
            for (var i = 0; i < productos.length; i++) {
                if (productos[i].name === opcion_seleccionada) {
                    console.log(productos[i].price);
                    if (productos[i].cantidad == 0) {
                        $('#Rprecio').val(productos[i].price).text();
                        $('#RDescripcion').val(productos[i].shortDescription).text();
                        $('#Rdispon').val('No disponible').text();
                        document.getElementById("RCantidad").readOnly = true;
                    }
                    else {
                        $('#Rprecio').val(productos[i].price).text();
                        $('#RDescripcion').val(productos[i].shortDescription).text();
                        $('#Rdispon').val(productos[i].cantidad).text();
                        document.getElementById("RCantidad").readOnly = false;
                        filita2();
                        if ($('#Rdispon').val() == 0) {
                            document.getElementById("RCantidad").readOnly = true;
                        }
                    }
                }
            }
        }

        function cargarFactura() {
            xhr2.open('GET', 'http://localhost:5913/Factura/ObtenerFactura', 'true');
            xhr2.responseType = 'text';
            xhr2.send();

            xhr2.onload = function () {
                if (xhr2.status === 200) {
                    factura = JSON.parse(xhr2.responseText);
                    console.log(factura);
                    factUltima = factura[factura.length - 1];
                    console.log(factUltima);
                    paso3();
                }

            }

        }

        $(document).ready(function () {
            $('select').formSelect();
        });

        $(document).ready(function () {
            $('.sidenav').sidenav();
        });

        $(document).ready(function () {
            $('.datepicker').datepicker();
        });

        var opcion_seleccionada = "";
        $(document).on('change','#ProductoId', function () {
            opcion_seleccionada = $("#ProductoId option:selected").text();
            console.log(opcion_seleccionada);
            cargarProductos();

        });
        //Tabla

        $(document).ready(function () {
            //obtenemos el valor de los input
            $('#adicionar').click(function () {
                var producto = document.getElementById("ProductoId").value;
                var rdescripcion = document.getElementById("RDescripcion").value;
                var rprecio = document.getElementById("Rprecio").value;
                var rcantidad = document.getElementById("RCantidad").value;
                var rdispon = document.getElementById("Rdispon").value;
                rcantidad = parseInt(rcantidad);
                rdispon = parseInt(rdispon);
                var importe = rcantidad * rprecio;
                var i = document.getElementById("mytable").rows.length; //contador para asignar id al boton que borrara la fila
                var descr = descricion();
                /*if (producto != "" && rdescripcion != "" && rprecio != "" && rcantidad != "" && rdispon != "") {
                    if (rdescripcion == descr) {
                        console.log('Iguales');
                        filita();

                    }
                    else {
                        if (rcantidad > rdispon) {
                            var toastHTML = '<span>Escriba una cantidad disponible</span><button class="btn-flat toast-action">Deshacer</button>';
                            M.toast({ html: toastHTML });
                            //alert("Esciba una cantidad menor");
                            document.getElementById("RCantidad").focus();
                        }
                    }
                    if ( rcantidad <= rdispon) {
                        var fila = '<tr id="row' + i + '"><td class="prod">' + producto + '</td><td>' + rdescripcion + '</td><td id="pre' + i + '">' + rprecio + '</td><td id="cant' + i + '">' + rcantidad + '</td><td id="imp' + i + '">' + importe + '</td><td><button type="button" name="remove" id="' + i + '" class="btn-floating btn-small waves-effect waves-light red"><i class="material-icons">delete</i></button></td></tr>'; //esto seria lo que contendria la fila
                        $('#mytable tr:last').after(fila);
                        $("#adicionados").text(""); //esta instruccion limpia el div adicioandos para que no se vayan acumulando
                        var nFilas = $("#mytable tr").length;
                        $("#adicionados").append(nFilas - 1);
                        //le resto 1 para no contar la fila del header
                        document.getElementById("ProductoId").value = "";
                        document.getElementById("RDescripcion").value = "";
                        document.getElementById("Rprecio").value = "";
                        document.getElementById("RCantidad").value = "";
                        document.getElementById("Rdispon").value = "";
                        document.getElementById("ProductoId").focus();
                    }
                }
                else {
                    if (rdispon == 0) {
                        var toastHTML = '<span>Producto agotado</span><button class="btn-flat toast-action">Deshacer</button>';
                        M.toast({ html: toastHTML });
                    }*/
                switch (producto != "" && rdescripcion != "" && rprecio != "" && rcantidad != "" && rdispon != "") {
                    case rdescripcion == descr:
                        console.log('Iguales');
                        filita();
                        break;

                    case document.getElementById("RCantidad").value > document.getElementById("Rdispon").value:
                        var toastHTML = '<span>Escriba una cantidad disponible</span><button class="btn-flat toast-action">Deshacer</button>';
                        M.toast({ html: toastHTML });
                        //alert("Esciba una cantidad menor");
                        document.getElementById("RCantidad").focus();
                        break;

                    case rcantidad <= rdispon:
                        var fila = '<tr id="row' + i + '"><td class="prod">' + producto + '</td><td>' + rdescripcion + '</td><td id="pre' + i + '">' + rprecio + '</td><td id="cant' + i + '">' + rcantidad + '</td><td id="imp' + i + '">' + importe + '</td><td><button type="button" name="remove" id="' + i + '" class="btn-floating btn-small waves-effect waves-light red"><i class="material-icons">delete</i></button></td></tr>'; //esto seria lo que contendria la fila
                        $('#mytable tr:last').after(fila);
                        $("#adicionados").text(""); //esta instruccion limpia el div adicioandos para que no se vayan acumulando
                        var nFilas = $("#mytable tr").length;
                        $("#adicionados").append(nFilas - 1);
                        //le resto 1 para no contar la fila del header
                        document.getElementById("ProductoId").value = "";
                        document.getElementById("RDescripcion").value = "";
                        document.getElementById("Rprecio").value = "";
                        document.getElementById("RCantidad").value = "";
                        document.getElementById("Rdispon").value = "";
                        document.getElementById("ProductoId").focus();
                        totalito();
                        break;
                    case document.getElementById("RCantidad").value == "" && document.getElementById("Rdispon").value == 0:
                        var toastHTML = '<span>Producto agotado</span><button class="btn-flat toast-action">Deshacer</button>';
                        M.toast({ html: toastHTML });
                        break;

                    default:
                        console.log('no jodas');
                }

            });

        });

            $(document).on('click', '.btn-floating', function () {
                var button_id = $(this).attr("id");
                //cuando da click obtenemos el id del boton
               var prueba = $("table thead tr:eq(" + button_id+")").find("td:nth-child(4)").text();
                console.log(prueba);
                console.log(button_id);
             if (prueba <= 1) {
                    $('#row' + button_id + '').remove(); //borra la fila
                    //limpia el para que vuelva a contar las filas de la tabla
                  $("#adicionados").text("");
                    var nFilas = $("#mytable tr").length;
                 $("#adicionados").append(nFilas - 1);
                 totalito();
             } else {
                 var button_id = $(this).attr("id");
                 var cant = $("table thead tr:eq(" + button_id + ")").find("td:nth-child(4)").text();
                 var pre = $("#pre" + button_id + "").text();
                 var imp = $("#imp" + button_id + "").text();
                 imp = parseInt(imp);
                 pre = parseInt(pre);
                 cant = cant - 1;
                 imp = cant * pre;
                 $("#cant" + button_id + "").text(cant);
                 $("#imp" + button_id + "").text(imp);
                 totalito();
               }
            });


        $(document).on('click', '.btn-floating', function () {

        });

        $(document).ready(function () {
            $("#mytable").bind("DOMSubtreeModified", function () {
                var tabla2 = document.getElementById("mytable");
                var tdsTabla2 = tabla2.getElementsByTagName("tr");
                var pp = 1;
                var btn = document.getElementsByName('remove');
                for (var i = 0; i < btn.length; i++) {
                    btn[i].attributes.id = pp;
                    pp++;
                }
            });

        });

        function descripcion_tabla() {

            var tabla2 = document.getElementById("mytable");
            var tdsTabla2 = tabla2.getElementsByTagName("tr");
            var cant = [];
            for (let i = 0; i < tdsTabla2.length; i++) {
                cant[i] = $("table thead tr:eq(" + i + " )").find("td:nth-child(2)").text();
                //console.log(cant[i]);
            }
            return cant;
        }

        function descricion() {
            var cant = descripcion_tabla();
            let test;
            var rdescripcion = document.getElementById("RDescripcion").value;
            for (let i = 0; i < cant.length; i++) {
                if (rdescripcion == cant[i]) {
                    test = cant[i];
                    //console.log(test);
                }
            }
            return test;
        }

        function filita() {
            var tabla2 = document.getElementById("mytable");
            var tdsTabla2 = tabla2.getElementsByTagName("tr");
            var cant = [];
            var canto = [];
            var canti, imp, pre;
            var rcantidad = document.getElementById("RCantidad").value;
            rcantidad = parseInt(rcantidad);
            var rdescripcion = document.getElementById("RDescripcion").value;
            for (let i = 0; i < tdsTabla2.length; i++) {
                cant[i] = $("table thead tr:eq(" + i + " )").find("td:nth-child(2)").text();
                canto[i] = $("table thead tr:eq(" + i + ")").find("td:nth-child(4)").text();
                if (rdescripcion == cant[i]) {
                    console.log(cant[i]);
                    console.log($("#cant" + i + "").text());
                    pre = $("#pre" + i + "").text();
                    imp = $("#imp" + i + "").text();
                    canti = $("#cant" + i + "").text();
                    canti = parseInt(canti) + rcantidad;
                    imp = parseInt(imp);
                    pre = parseInt(pre);
                    imp = canti * pre;
                    $("#cant" + i + "").text(canti);
                    $("#imp" + i + "").text(imp);
                    console.log(imp);
                }
                //console.log(cant[i]);
                //canto = canto + rcantidad;
                //$("#cant" + i + "").text(canto);

            }
            document.getElementById("ProductoId").value = "";
            document.getElementById("RDescripcion").value = "";
            document.getElementById("Rprecio").value = "";
            document.getElementById("RCantidad").value = "";
            document.getElementById("Rdispon").value = "";
            document.getElementById("ProductoId").focus();
            totalito();
        }
        var elim = [];
        $(document).ready(function () {
            $("#elim").click(function () {
                var valores = [];
                var pipo = "";
                $(".prod").parent("tr").find("td").each(function () {
                    if ($(this).text() != "delete") {
                        valores += $(this).text() + " ";
                    }
                });
                $("td").each(function () {
                    pipo = $(this).text();
                });
                valores = valores + "\n";
                elim = valores;
                console.log(valores);
            });
        });

        function facturar () {
                detalles.shift();
                console.log(detalles);

                ///POST
                var i = 0;
                for (i = 0; i < detalles.length;i++) {
                    if (detalles[i] != null) {
                        $.ajax({
                            type: "POST",
                            url: "@Url.Action("Create", "Detalle")",
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify(detalles[i]),
                            success: function (result) {
                                console.log('Data received: ');
                                console.log(result);

                            },
                            failure: function (errMsg) {
                                alert(errMsg);
                            }
                        });
                    }
                }
                console.log(detalles);
            datos_generar();

        }
        function cargadetalles() {
            ///DETALLES E ID PRODUCTO
            var tabla2 = document.getElementById("mytable");
            var tdsTabla2 = tabla2.getElementsByTagName("tr");
            var i = 0;
            var f = 0
            var ilo = ['', 'ProductoId', 'Descripcion', 'Precio', 'Cantidad', 'Importe'];
            for (i = 0; i < tdsTabla2.length; i++) {
                for (f = 0; f < 6; f++) {

                    detalles[i] = {
                        FacturaId: factUltima.facturaId,
                        ProductoId: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(1)").text()),
                        //Descripcion: $("table thead tr:eq(" + i + ")").find("td:nth-child(2)").text(),
                        Precio: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(3)").text()),
                        Cantidad: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(4)").text()),
                        Importe: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(5)").text())
                    }
                }
            }
            paso4();
        }
        function paso1() {
            console.log('paso 1');
            var factura = {
                ClienteId: $('#ClienteId').val(),
                Fecha: $('#Fecha').val()
            }
            if (factura != null) {
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("Create", "Factura")",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(factura),
                    success: function (result) {
                        console.log('Data received: ');
                        console.log(result);
                        paso2();
                    },
                    failure: function (errMsg) {
                        alert(errMsg);
                    }
                });
            }
            console.log(factura);
        }
        function paso2() {
            console.log('paso 2');
            cargarFactura();
        }
        function paso3() {
            console.log('paso 3');
            cargadetalles();
        }
        function paso4() {
            console.log('paso 4');
            facturar();
        }
        function paso5() {
            console.log('paso 5');
            generar();
        }
        function filita2() {
            var tabla2 = document.getElementById("mytable");
            var tdsTabla2 = tabla2.getElementsByTagName("tr");
            var des = [];
            var dad = [];
            var canti, imp, pre;
            var rcantidad = document.getElementById("Rdispon").value;
            rcantidad = parseInt(rcantidad);
            var rdescripcion = document.getElementById("RDescripcion").value;
            for (let i = 0; i < tdsTabla2.length; i++) {
                des[i] = $("table thead tr:eq(" + i + " )").find("td:nth-child(2)").text();
                dad[i] = $("table thead tr:eq(" + i + ")").find("td:nth-child(4)").text();
                if (rdescripcion == des[i]) {
                    console.log(des[i]);
                    canti = $("#cant" + i + "").text();
                    canti = parseInt(canti);
                    rcantidad = rcantidad - canti;
                    document.getElementById("Rdispon").value = rcantidad;
                }
                //console.log(cant[i]);
                //canto = canto + rcantidad;
                //$("#cant" + i + "").text(canto);

            }
        }

        ///pdf
        function datos_generar() {
            var tabla2 = document.getElementById("mytable");
            var tdsTabla2 = tabla2.getElementsByTagName("tr");
            var i = 0;
            var f = 0
            var ilo = ['', 'ProductoId', 'Descripcion', 'Precio', 'Cantidad', 'Importe'];
            for (i = 0; i < tdsTabla2.length; i++) {
                for (f = 0; f < 6; f++) {

                    datos_g[i] = [

                        $("table thead tr:eq(" + i + ")").find("td:nth-child(1)").text(),
                        $("table thead tr:eq(" + i + ")").find("td:nth-child(2)").text(),
                        $("table thead tr:eq(" + i + ")").find("td:nth-child(3)").text(),
                        $("table thead tr:eq(" + i + ")").find("td:nth-child(4)").text(),
                        $("table thead tr:eq(" + i + ")").find("td:nth-child(5)").text()
                    ]
                }
            }
            datos_g.shift();
            paso5();
        }

        function generar() {
            var pdf = new jsPDF();
            pdf.setFontSize(22)
            pdf.text(160, 20, "Factura");
            pdf.setFontSize(12)
            pdf.text(160, 40, "No. Factura: " + factUltima.facturaId + "");
            pdf.text(160, 45, "Fecha: " + document.getElementById("Fecha").value+"");
            pdf.setFontSize(12)
            pdf.text(15, 50, "Nombre Cliente:  " + $("#ClienteId option:selected").text()+ "");

            var columns = ["Codigo", "Descripcion", "Precio", "Cantidad", "Importe"];
            var data = [
                [1, "Hola", "hola@gmail.com", "Mexico"],
                [2, "Hello", "hello@gmail.com", "Estados Unidos"],
                [3, "Otro", "otro@gmail.com", "Otro"]
            ];

            pdf.autoTable(columns, datos_g,
                { margin: { top: 55 } },

            );
            let finalY = pdf.autoTable.previous.finalY+10; // The y position on the page
            pdf.text(155, finalY, "Total: " + total +"")
            pdf.save('mipdf.pdf');

        }

        function totalito() {
            var tabla2 = document.getElementById("mytable");
            var tdsTabla2 = tabla2.getElementsByTagName("tr");
            var i = 0;
            var f = 0
            var ilo = ['', 'ProductoId', 'Descripcion', 'Precio', 'Cantidad', 'Importe'];
            for (i = 0; i < tdsTabla2.length; i++) {
                for (f = 0; f < 6; f++) {

                    sumatoria[i] = {

                        ProductoId: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(1)").text()),
                        //Descripcion: $("table thead tr:eq(" + i + ")").find("td:nth-child(2)").text(),
                        Precio: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(3)").text()),
                        Cantidad: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(4)").text()),
                        Importe: parseInt($("table thead tr:eq(" + i + ")").find("td:nth-child(5)").text())
                    }
                }
            }
            sumatoria.shift();
            var n = 0;
            total = 0;
            for (n = 0; n < sumatoria.length; n++) {
                total += sumatoria[n].Importe;
            }
            document.getElementById("Rtotal").innerHTML = total;
        }
        ///fin pdf
        cargarProductos();
    </script>

</head>
<body>
    <header>
        <nav>
            <div class="nav-wrapper">
                <a href="#" class="brand-logo  center">Inventario</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down" style="transform: translateX(0px);"></ul>
                <div class="container"><a href="#" data-target="slide-out" class="top-nav sidenav-trigger full hide-on-large-only"><i class="material-icons">menu</i></a></div>
            </div>
        </nav>
        <ul id="slide-out" class="sidenav sidenav-fixed" style="overflow: inherit;">
            <li>
                <div class="user-view">
                    <div class="background">
                        <img src="~/images/icono2.png">
                    </div>
                    <br />
                    <br />
                </div>
            </li>
            <li><a asp-controller="Home" asp-action="Index"><i class="material-icons">home</i>Home</a></li>
            <li><a asp-controller="Cliente" asp-action="List"><i class="material-icons">account_circle</i>Cliente</a></li>
            <li><a asp-controller="Proveedor" asp-action="List"><i class="material-icons">supervisor_account</i>Proveedores</a></li>
            <li><a asp-controller="Producto" asp-action="List"><i class="material-icons">local_offer</i>Productos</a></li>
            <li><a asp-controller="Factura" asp-action="Create"><i class="material-icons">shopping_cart</i>Facturacion</a></li>
            <li><a class="nounderline" href="#about"><i class="material-icons">timeline</i>Reportes ventas</a></li>
            <li><a class="nounderline" href="#about"><i class="material-icons">build</i>Mantenimiento</a></li>
            <li><a class="nounderline" href="#about"><i class="material-icons">settings</i>Configuracion</a></li>
            @if (SignInManager.IsSignedIn(User))
             {
                    <form asp-area="" asp-controller="Account" asp-action="Logout" id="logoutForm"
                          method="post" class="navbar-right">
                        <li><a href="javascript:document.getElementById('logoutForm').submit()"><i class="material-icons">exit_to_app</i>Salir</a></li>

                    </form>
             }
            else
            {

                    <li><a asp-controller="Account" asp-action="Register"><i class="material-icons">help</i>Ayuda</a></li>
                    <li><a asp-controller="Account" asp-action="Login"><i class="material-icons">exit_to_app</i>Salir</a></li>

            }
        </ul>

        
    </header>
    <div class="container" id="container">
        <div class="row">
            <div class="col s12 m8 offset-m1 x17 offset-xl2">
                @RenderBody()
            </div>
        </div>
    </div>

    <!-- jQuery is required by Materialize to function -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-alpha.4/js/materialize.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="../../lib/materialize/js/materialize.min.js"></script>
    <!---<script src="~/misJs/propios.js"></script>-->


</body>
</html>
